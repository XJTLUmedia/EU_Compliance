{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1>Compliance Report</h1>
        <p class="lead">Analysis for {{ report.business_info.business_name or 'Your Business' }}</p>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="mb-0">Compliance Score</h3>
                <span class="badge {% if report.analysis_result.overall_compliance_score >= 80 %}bg-success{% elif report.analysis_result.overall_compliance_score >= 60 %}bg-warning{% else %}bg-danger{% endif %} fs-5">
                    {{ report.analysis_result.overall_compliance_score or 0 }}/100
                </span>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="progress" style="height: 30px;">
                            <div class="progress-bar {% if report.analysis_result.overall_compliance_score >= 80 %}bg-success{% elif report.analysis_result.overall_compliance_score >= 60 %}bg-warning{% else %}bg-danger{% endif %}" 
                                 role="progressbar" 
                                 style="width: {{ report.analysis_result.overall_compliance_score or 0 }}%" 
                                 aria-valuenow="{{ report.analysis_result.overall_compliance_score or 0 }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                {{ report.analysis_result.overall_compliance_score or 0 }}%
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="mt-3 mt-md-0">
                            {% if report.analysis_result.overall_compliance_score >= 80 %}
                            <span class="text-success"><i class="bi bi-check-circle-fill"></i> Good Compliance</span>
                            {% elif report.analysis_result.overall_compliance_score >= 60 %}
                            <span class="text-warning"><i class="bi bi-exclamation-triangle-fill"></i> Moderate Compliance</span>
                            {% else %}
                            <span class="text-danger"><i class="bi bi-x-circle-fill"></i> Poor Compliance</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <h3>Regulatory Requirements</h3>
            </div>
            <div class="card-body">
                {% if report.analysis_result.regulatory_requirements %}
                <ul class="list-group">
                    {% for requirement in report.analysis_result.regulatory_requirements %}
                    <li class="list-group-item">{{ requirement }}</li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted">No regulatory requirements identified.</p>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <h3>Compliance Gaps</h3>
            </div>
            <div class="card-body">
                {% if report.analysis_result.compliance_gaps %}
                <ul class="list-group">
                    {% for gap in report.analysis_result.compliance_gaps %}
                    <li class="list-group-item">{{ gap }}</li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted">No compliance gaps identified.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3>Recommended Actions</h3>
            </div>
            <div class="card-body">
                {% if report.analysis_result.action_items %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Action</th>
                                <th>Priority</th>
                                <th>Timeline</th>
                                <th>Estimated Cost</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in report.analysis_result.action_items %}
                            <tr>
                                <td>{{ item.action }}</td>
                                <td>
                                    <span class="badge {% if item.priority == 'High' %}bg-danger{% elif item.priority == 'Medium' %}bg-warning{% else %}bg-info{% endif %}">
                                        {{ item.priority }}
                                    </span>
                                </td>
                                <td>{{ item.timeline }}</td>
                                <td>{{ item.estimated_cost }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">No action items identified.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3>Non-Compliance Risks</h3>
            </div>
            <div class="card-body">
                {% if report.analysis_result.risks %}
                <div class="row">
                    {% for risk in report.analysis_result.risks %}
                    <div class="col-md-6 mb-3">
                        <div class="card border-danger">
                            <div class="card-body">
                                <h5 class="card-title text-danger"><i class="bi bi-exclamation-triangle-fill"></i> Risk</h5>
                                <p class="card-text">{{ risk }}</p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">No significant risks identified.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3>Cost Estimate Summary</h3>
            </div>
            <div class="card-body">
                {% if report.cost_estimate and not report.cost_estimate.get('error') %}
                <div class="row">
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h5 class="card-title">One-Time Costs</h5>
                                <p class="card-text display-6">{{ report.cost_estimate.one_time_costs or 'N/A' }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h5 class="card-title">Annual Costs</h5>
                                <p class="card-text display-6">{{ report.cost_estimate.annual_recurring_costs or 'N/A' }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h5 class="card-title">Potential Fines</h5>
                                <p class="card-text display-6">{{ report.cost_estimate.potential_fines or 'N/A' }}</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                {% if report.cost_estimate.roi_calculation %}
                <div class="mt-4">
                    <h5>ROI Calculation</h5>
                    <p>{{ report.cost_estimate.roi_calculation }}</p>
                </div>
                {% endif %}
                
                {% if report.cost_estimate.cost_saving_opportunities %}
                <div class="mt-4">
                    <h5>Cost-Saving Opportunities</h5>
                    <p>{{ report.cost_estimate.cost_saving_opportunities }}</p>
                </div>
                {% endif %}
                {% else %}
                <p class="text-muted">No cost estimate available.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3>Compliance Roadmap</h3>
            </div>
            <div class="card-body">
                {% if report.roadmap and not report.roadmap.get('error') %}
                {% if report.roadmap.monthly_milestones %}
                <h5>Monthly Milestones</h5>
                <div class="accordion" id="roadmapAccordion">
                    {% for month, activities in report.roadmap.monthly_milestones.items() %}
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading{{ month }}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ month }}" aria-expanded="false" aria-controls="collapse{{ month }}">
                                Month {{ month }}
                            </button>
                        </h2>
                        <div id="collapse{{ month }}" class="accordion-collapse collapse" aria-labelledby="heading{{ month }}" data-bs-parent="#roadmapAccordion">
                            <div class="accordion-body">
                                <ul class="list-group">
                                    {% for activity in activities %}
                                    <li class="list-group-item">{{ activity }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                {% if report.roadmap.resource_requirements %}
                <div class="mt-4">
                    <h5>Resource Requirements</h5>
                    <div class="row">
                        {% for category, details in report.roadmap.resource_requirements.items() %}
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">{{ category }}</h5>
                                    {% if details is mapping %}
                                    <ul class="list-group list-group-flush">
                                        {% for item, value in details.items() %}
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            {{ item }}
                                            <span>{{ value }}</span>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                    {% else %}
                                    <p>{{ details }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                {% if report.roadmap.critical_path_items %}
                <div class="mt-4">
                    <h5>Critical Path Items</h5>
                    <ol>
                        {% for item in report.roadmap.critical_path_items %}
                        <li>{{ item }}</li>
                        {% endfor %}
                    </ol>
                </div>
                {% endif %}
                
                {% if report.roadmap.contingency_plans %}
                <div class="mt-4">
                    <h5>Contingency Plans</h5>
                    <div class="row">
                        {% for challenge, plan in report.roadmap.contingency_plans.items() %}
                        <div class="col-md-6">
                            <div class="card border-warning">
                                <div class="card-body">
                                    <h5 class="card-title text-warning">Challenge: {{ challenge }}</h5>
                                    <p class="card-text">{{ plan }}</p>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                {% else %}
                <p class="text-muted">No roadmap available.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3>Download Reports</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="d-grid">
                            <a href="{{ url_for('download_report', report_id=report.id, report_type='compliance') }}" class="btn btn-primary">
                                <i class="bi bi-download"></i> Download Compliance Report (PDF)
                            </a>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-grid">
                            <a href="{{ url_for('download_report', report_id=report.id, report_type='roadmap') }}" class="btn btn-primary">
                                <i class="bi bi-download"></i> Download Compliance Roadmap (PDF)
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="alert alert-warning">
            <h5>Disclaimer</h5>
            <p>This report is generated by an AI system and should be reviewed by qualified legal professionals before taking any compliance actions. The information provided is based on available regulatory data and AI analysis, which may not capture all nuances of specific business situations or the latest regulatory changes. The service provider assumes no liability for decisions made based on this report.</p>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="d-flex justify-content-between">
            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">Back to Dashboard</a>
            <a href="{{ url_for('compliance_analysis') }}" class="btn btn-primary">Run New Analysis</a>
        </div>
    </div>
</div>
{% endblock %}